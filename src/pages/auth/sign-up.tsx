import { Helmet } from 'react-helmet-async'
import { useForm } from 'react-hook-form'
import { Link, useNavigate } from 'react-router-dom'
import { toast } from 'sonner'
import { z } from 'zod'

import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { createReport } from '@/api/create-report'

const signUpForm = z.object({
  customerName: z.string(),
  address: z.string(),
  document: z.string(),
  phone: z.string(),
  email: z.string().email(),
  technicianName: z.string(),
  sampleOrigin: z.string(),
  sampleType: z.string(),
  entryDate: z.string(),
  collectionDate: z.string(),
  collectionTime: z.string(),
  collectionAgent: z.string(),
  notes: z.string().optional(),
  analysisResults: z.record(z.string(), z.string()),
  signedPdfUrl: z.string().optional(),
  sampleImageUrls: z.array(z.string()).optional(),
})

type SignUpForm = z.infer<typeof signUpForm>

export function SignUp() {
  const navigate = useNavigate()

  const {
    register,
    handleSubmit,
    formState: { isSubmitting },
    reset,
  } = useForm<SignUpForm>()

  async function handleSignUp(data: SignUpForm) {
    console.log('Dados antes do envio:', data) // 游녣 Adicione esta linha
    try {
      // Formatando os dados para o schema esperado
      const formattedData = {
        ...data,
        // Convertendo campos de an치lise para o formato record
        analysisResults: Object.fromEntries(
          Object.entries(data.analysisResults || {}).filter(
            ([_, value]) => value !== '',
          ),
        ),
        //  signedPdfUrl: '', // Ser치 preenchido ap칩s gera칞칚o do PDF
        // sampleImageUrls: [], // Pode ser preenchido posteriormente
      }

      await createReport(formattedData)

      toast.success('Laudo cadastrado com sucesso!', {
        action: {
          label: 'Login',
          onClick: () => navigate('/sign-in'),
        },
      })
      reset() // Limpa o formul치rio ap칩s envio
    } catch (error) {
      //console.error('Erro detalhado:', error.response?.data) // 游녣 Mostra o erro do backend
      toast.error('Erro ao cadastrar o laudo.')
    }
  }

  // Campos de an치lise padr칚o
  const analysisFields = [
    { key: 'fluoreto', label: 'Fluoreto - m치x. 1.5 mg/L' },
    { key: 'turbidez', label: 'Turbidez - m치x. 5 uT (PRT GM/MS n췈 888/21)' },
    {
      key: 'corAparente',
      label: 'Cor Aparente - m치x. 15 uH (PRT GM/MS n췈 888/21)',
    },
    { key: 'ph', label: 'pH - faixa 6.0 a 9.5' },
    { key: 'temperatura', label: 'Temperatura - monitoramento (춿C)' },
    { key: 'alcalinidade', label: 'Alcalinidade - m치x. 120 mg/L' },
    { key: 'durezaTotal', label: 'Dureza total - m치x. 500 mg/L' },
    { key: 'durezaCalcio', label: 'Dureza de C치lcio - monitoramento (mg/L)' },
    {
      key: 'durezaMagnesio',
      label: 'Dureza de Magn칠sio - monitoramento (mg/L)',
    },
    { key: 'cloretos', label: 'Cloretos - m치x. 250 mg/L' },
    {
      key: 'materiaOrganica',
      label: 'Mat칠ria Org칙nica - monitoramento (mg/L)',
    },
    { key: 'condutividade', label: 'Condutividade - m치x. 100 췃S/cm' },
    {
      key: 'solidosDissolvidos',
      label: 'S칩lidos Totais Dissolvidos - m치x. 1000 mg/L',
    },
    { key: 'aluminio', label: 'Alum칤nio - m치x. 0.2 mg/L' },
    { key: 'ferro', label: 'Ferro - m치x. 0.3 mg/L' },
    { key: 'manganes', label: 'Mangan칡s - m치x. 0.1 mg/L' },
    { key: 'amonia', label: 'Am칪nia / Nitrog칡nio Amoniacal - m치x. 1.5 mg/L' },
    { key: 'fosforoTotal', label: 'F칩sforo Total - m치x. 0.1 mg/L' },
    { key: 'nitrato', label: 'Nitrato - m치x. 10 mg/L' },
    { key: 'nitrito', label: 'Nitrito - m치x. 1 mg/L' },
    { key: 'sulfato', label: 'Sulfato - m치x. 250 mg/L' },
    {
      key: 'sulfetoHidrogenio',
      label: 'Sulfeto de Hidrog칡nio - m치x. 0.002 mg/L',
    },
    { key: 'gasCarbonico', label: 'G치s Carb칪nico - monitoramento (mg/L)' },
    { key: 'sodio', label: 'S칩dio - m치x. 200 mg/L' },
    {
      key: 'coliformeTotal',
      label:
        '칈nd.Coliforme Total - Presen칞a em at칠 5% das amostras - N.M.P/100 mL - SMEWW 9222 B',
    },
    {
      key: 'escherichiaColi',
      label:
        '칈ndice de Escherichia Coli - Ausente - N.M.P/100 mL - SMEWW 9221 F',
    },
  ]

  return (
    <>
      <Helmet title="Cadastro" />

      <div className="p-24">
        <Button variant="default" asChild className="absolute right-8 top-24">
          <Link to="/sign-in">Buscar resultado</Link>
        </Button>

        <div className="flex w-full max-w-3xl flex-col justify-center gap-6 mx-auto">
          <div className="flex flex-col gap-2 text-center">
            <h1 className="text-2xl font-semibold tracking-tight">
              Cadastrar Laudo de Amostra
            </h1>
            <p className="text-sm text-muted-foreground">
              Informe os dados do cliente, da amostra e os resultados das
              an치lises.
            </p>
          </div>

          <form className="space-y-4" onSubmit={handleSubmit(handleSignUp)}>
            {/* Dados do Cliente */}
            <div className="space-y-2">
              <Label htmlFor="customerName">Nome do Cliente</Label>
              <Input
                id="customerName"
                type="text"
                {...register('customerName', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="address">Endere칞o</Label>
              <Input
                id="address"
                type="text"
                {...register('address', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="document">CPF ou CNPJ</Label>
              <Input
                id="document"
                type="text"
                {...register('document', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="technicianName">
                Nome do T칠cnico Respons치vel
              </Label>
              <Input
                id="technicianName"
                type="text"
                {...register('technicianName', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="email">E-mail</Label>
              <Input
                id="email"
                type="email"
                {...register('email', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="phone">Celular</Label>
              <Input
                id="phone"
                type="tel"
                {...register('phone', { required: true })}
              />
            </div>

            {/* Dados da Amostra */}
            <div className="space-y-2">
              <Label htmlFor="sampleOrigin">Origem da Amostra</Label>
              <Input
                id="sampleOrigin"
                type="text"
                {...register('sampleOrigin', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="sampleType">Tipo de Amostra</Label>
              <Input
                id="sampleType"
                type="text"
                {...register('sampleType', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="entryDate">Data de Entrada</Label>
              <Input
                id="entryDate"
                type="date"
                {...register('entryDate', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="collectionDate">Data da Coleta</Label>
              <Input
                id="collectionDate"
                type="date"
                {...register('collectionDate', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="collectionTime">Hora da Coleta</Label>
              <Input
                id="collectionTime"
                type="time"
                {...register('collectionTime', { required: true })}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="collectionAgent">Respons치vel pela Coleta</Label>
              <Input
                id="collectionAgent"
                type="text"
                {...register('collectionAgent', { required: true })}
              />
            </div>

            {/* Resultados da An치lise */}
            <div className="pt-4">
              <h2 className="text-lg font-semibold mb-2">
                Laudo de An치lise F칤sico-Qu칤mica da 츼gua
              </h2>
              <p className="text-sm text-muted-foreground mb-4">
                Preencha os campos com os resultados das an치lises.
              </p>

              {analysisFields.map((field) => (
                <div className="space-y-2" key={field.key}>
                  <Label htmlFor={`analysisResults.${field.key}`}>
                    {field.label}
                  </Label>
                  <Input
                    id={`analysisResults.${field.key}`}
                    type="text"
                    {...register(`analysisResults.${field.key}`)}
                  />
                </div>
              ))}

              <div className="space-y-2">
                <Label htmlFor="notes">Observa칞칫es</Label>
                <Textarea id="notes" {...register('notes')} />
              </div>
            </div>

            <Button disabled={isSubmitting} className="w-full" type="submit">
              Salvar Resultados
            </Button>

            <p className="px-6 text-center text-sm leading-relaxed text-muted-foreground">
              Ao continuar, voc칡 concorda com nossos{' '}
              <a href="" className="underline underline-offset-4">
                termos de servi칞o
              </a>{' '}
              e{' '}
              <a href="" className="underline underline-offset-4">
                pol칤ticas de privacidade
              </a>
            </p>
          </form>
        </div>
      </div>
    </>
  )
}
